/*=========================================================================

  Program:   ORFEO Toolbox
  Language:  C++
  Date:      $Date$
  Version:   $Revision$


  Copyright (c) Centre National d'Etudes Spatiales. All rights reserved.
  See OTBCopyright.txt for details.


     This software is distributed WITHOUT ANY WARRANTY; without even
     the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
     PURPOSE.  See the above copyright notices for more information.

=========================================================================*/
#ifndef __otbAtmosphericCorrectionsReduceSpectralResponse_txx
#define __otbAtmosphericCorrectionsReduceSpectralResponse_txx




// #include "otbAtmosphericCorrectionParameters.h"
// #include "otbAtmosphericRadiativeTerms.h"
#include "otbAtmosphericCorrectionsReduceSpectralResponse.h"
#include "otbAtmosphericCorrectionParametersTo6SAtmosphericRadiativeTerms.h"
#include "otbSurfaceReflectanceToReflectanceFilter.h"
// #include "otbAtmosphericCorrectionParameters.h"
namespace otb
{

template <class TSpectralResponse ,class TRSR>
AtmosphericCorrectionsReduceSpectralResponse<TSpectralResponse ,TRSR>
::AtmosphericCorrectionsReduceSpectralResponse()
  {
    //m_InputSpectralResponse = VectorType::New();
  }
/*
template <class TSpectralResponse ,class TRSR>
void  
AtmosphericCorrectionsReduceSpectralResponse<TSpectralResponse ,TRSR>
::LoadFilterFunctionAtmosphericCorrectionParameters(double step)
{
  //LMoad the filter function from the RSR
  for (unsigned int i=0; i<this->m_InputSatRSR->GetNbBands(); ++i)
  {
    m_DataAtmosphericCorrectionParameters->SetWavelenghtSpectralBandWithIndex(i, this->m_InputSatRSR->GetRSR()[i]->GetFilterFunctionValues (step));
  }
}
*/
template <class TSpectralResponse ,class TRSR>
void  
AtmosphericCorrectionsReduceSpectralResponse<TSpectralResponse ,TRSR>
::Process6S(/*const unsigned int numBand*/)
{
  typedef otb::AtmosphericCorrectionParametersTo6SAtmosphericRadiativeTerms
      AtmosphericCorrectionParametersTo6SRadiativeTermsType;
  
  AtmosphericCorrectionParametersTo6SRadiativeTermsType::Pointer  filterAtmosphericCorrectionParametersTo6SRadiativeTerms = AtmosphericCorrectionParametersTo6SRadiativeTermsType::New();

    //Set filter function to 1 to get the RSR Sat!!!//TODO
  typedef otb::FilterFunctionValues
      FilterFunctionValuesType;
  typedef FilterFunctionValuesType::ValuesVectorType
      ValuesVectorType;
  ValuesVectorType valuesVector;
  const double step = 0.0025;
  //unsigned int j = 0;
  for (unsigned int i=0;i < this->m_InputSatRSR->GetNbBands();++i)
  {
    //Foreach band
    valuesVector.clear();
    std::pair <typename Superclass::PrecisionType,typename Superclass::PrecisionType> inter;
    inter = (this->m_InputSatRSR->GetRSR())[i]->GetInterval();
    otbGenericMsgDebugMacro(<<"inter " << inter.first << " " << inter.second);
    for ( double j=inter.first ; j <= inter.second; j+=step)
    {
      valuesVector.push_back(1.0);
    }  
    FilterFunctionValuesType::Pointer functionValues = FilterFunctionValuesType::New();
    functionValues->SetFilterFunctionValues(valuesVector);
    
    functionValues->SetMinSpectralValue(inter.first);
    otbGenericMsgDebugMacro(<<"inter.second - step " << inter.second - step);
    functionValues->SetMaxSpectralValue(inter.second - step);
  
  //TODO Is it the effecient method Problem in 6STraits
    //functionValues->SetUserStep(0.0025);
    functionValues->SetUserStep( step );
  
    m_DataAtmosphericCorrectionParameters->SetWavelenghtSpectralBandWithIndex(i, functionValues);
//     m_DataAtmosphericCorrectionParameters->SetWavelenghtSpectralBandWithIndex(0, functionValues);
  }
  
  
  otbGenericMsgDebugMacro(<<"valuesVector.size() " << valuesVector.size());
    
  filterAtmosphericCorrectionParametersTo6SRadiativeTerms->SetInput( m_DataAtmosphericCorrectionParameters );
  
  otbGenericMsgDebugMacro(<<"6S parameters " << m_DataAtmosphericCorrectionParameters);
  filterAtmosphericCorrectionParametersTo6SRadiativeTerms->Update();
   
  otbGenericMsgDebugMacro(<<"6S radiative term performed");
  
  typedef typename Superclass::InputSpectralResponseType::ImageType       ImageType;
  
  typedef SurfaceReflectanceToReflectanceFilter<ImageType, ImageType>              SurfaceReflectanceToReflectanceFilterType;
  typename SurfaceReflectanceToReflectanceFilterType::Pointer filterSRToR = SurfaceReflectanceToReflectanceFilterType::New();

  filterSRToR->SetAtmosphericRadiativeTerms( filterAtmosphericCorrectionParametersTo6SRadiativeTerms->GetOutput() );
  filterSRToR->SetInput( this->m_InputSpectralResponse->GetImage() );
   
  filterSRToR->Update();
  
  otbGenericMsgDebugMacro(<<"image reflectance " << filterSRToR->GetOutput());
  
  this->m_InputSpectralResponse->SetFromImage( filterSRToR->GetOutput() );
}
} // end namespace otb

#endif
